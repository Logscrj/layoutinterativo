<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contagem de Estoque e Invent√°rio</title>
    
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        /* --- Estilos de Navega√ß√£o (Abas) --- */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #f4f4f9;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 3px solid #4CAF50;
            color: #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* --- Estilos do Formul√°rio/Contagem --- */
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            margin-top: 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-registrar {
            background-color: #4CAF50;
            color: white;
            width: 100%;
        }
        #btn-scanner {
            background-color: #2196F3;
            color: white;
            width: 100%;
            margin-bottom: 10px;
            margin-top: 5px; 
        }
        .alerta {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        #leitor-qr-code {
            width: 100%;
            margin-top: 10px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            display: none; 
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Sistema de Contagem de Estoque</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('tab-registrar', this)">1. Registrar Contagem üìù</button>
            <button class="tab-button" onclick="showTab('tab-layout-contagem', this)">2. Visualizar Contagens por Data üìä</button>
        </div>

        <div id="tab-registrar" class="tab-content active">
            <h2>Registrar Nova Contagem de Estoque</h2>
            <form id="form-contagem" onsubmit="adicionarContagem(event)">

                <label for="campo-local-contagem">Local/√Årea Contada:</label>
                <input type="text" id="campo-local-contagem" placeholder="Ex: Rua 3, P√°tio A" required>
                
                <label for="campo-codigo-contagem">C√≥digo do Material (QR Code ou Digitar):</label>
                <input type="text" id="campo-codigo-contagem" oninput="atualizarNomeMaterialContagem(this.value)" required>
                
                <button type="button" id="btn-scanner" onclick="iniciarScanner()">
                    Abrir C√¢mera (QR Code) üì∑
                </button>
                <div id="leitor-qr-code"></div>
                
                <p id="nome-material-contagem" style="margin-top: 5px; font-style: italic; color: #555;">Nome do Material: N/A</p>
                <input type="hidden" id="campo-nome-contagem" value="">
                
                <label for="campo-data-contagem">Data da Contagem:</label>
                <input type="date" id="campo-data-contagem" value="" required>

                <label for="campo-quantidade-contagem">Quantidade Contada:</label>
                <input type="number" step="any" id="campo-quantidade-contagem" value="0" min="0" required>
                
                <button type="submit" id="btn-registrar">Registrar Contagem</button>
                <p id="mensagem-alerta" class="alerta"></p>
            </form>

            <hr>
            <h3>Contagens Recentes (Total: <span id="total-contagens">0</span>)</h3>
            <table id="tabela-contagens">
                <thead>
                    <tr>
                        <th>Local</th>
                        <th>C√≥d.</th>
                        <th>Nome Material</th>
                        <th>Data</th>
                        <th>Qtd.</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button onclick="limparContagens()" style="background-color: #f44336; color: white;">Limpar Todas as Contagens</button>
        </div>

        <div id="tab-layout-contagem" class="tab-content">
            <h2>Resumo das Contagens por Data</h2>
            <p>Selecione uma data para visualizar o invent√°rio consolidado por local e material.</p>
            
            <label for="filtro-data-layout">Visualizar Contagens da Data:</label>
            <input type="date" id="filtro-data-layout" onchange="renderizarResumoPorData(this.value)">

            <div id="layout-display-dinamico" style="margin-top: 15px;">
                </div>
        </div>

    </div>

    <script>
        // --- BASE DE DADOS E L√ìGICA DO INVENT√ÅRIO ---
        
        const BASE_ITENS = {
            // C√≥digo Limpo (sem prefixo Q000) : Nome do Material
            "92983": "CH V GYP ST BR12,5-120X180",
            "92993": "CH V GYP ST BR12.5-120X240", 
            "4577023": "GESSO RECICLADO",
            "313665": "CH GYP GWD BR12,5-120X240",
            "142685": "SUPERBOARD ST BQ 6MM 1200X2400",
            "4066969": "FIX IB GYP TB 3,5X25 CX 1.000",
            "4094219": "ACAB R GYP GWD TELA P/JUNTAS 20CMX50M RL",
            "140358": "CH V GYP ST BR6,4-120X240",
            "142687": "SUPERBOARD ST BQ 10MM 1200X2400",
            "93018": "CH V GYP ST BR12,5-120X270",
            "304393": "CH V PROMAPRO+ RF BR15,0-120X240",
            "4066968": "FIX IB GYP TA 3,5X45 CX 500",
            "93022": "CH V GYP ST BR12,5-120X240",
        };
        
        function showTab(tabId, button) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            button.classList.add('active');
            
            if (tabId === 'tab-layout-contagem') {
                const dataSelecionada = document.getElementById('filtro-data-layout').value;
                renderizarResumoPorData(dataSelecionada);
            }
            
            if (isScanning && tabId !== 'tab-registrar') {
                pararScanner();
            }
        }

        // --- FUN√á√ïES GERAIS ---

        function extrairCodigoMaterial(codigoBruto) {
            const match = codigoBruto.match(/Q00060(\d+)/);
            if (match && match[1]) {
                return match[1];
            }
            return codigoBruto; 
        }

        function atualizarNomeMaterialContagem(codigoBruto) {
            const codigo = extrairCodigoMaterial(codigoBruto);
            const nome = BASE_ITENS[codigo] || "N√ÉO ENCONTRADO na base de itens.";
            
            document.getElementById('nome-material-contagem').textContent = `Nome do Material: ${nome}`;
            document.getElementById('campo-nome-contagem').value = nome;
            
            const alerta = document.getElementById('mensagem-alerta');
            if (!BASE_ITENS[codigo] && codigoBruto.length > 0) {
                alerta.textContent = "‚ö†Ô∏è C√≥digo n√£o encontrado. Verifique a base de dados.";
            } else {
                alerta.textContent = "";
            }
        }
        
        // --- L√ìGICA DE CONTROLE DE DADOS (Contagens) ---
        
        function carregarContagens() {
            const contagens = JSON.parse(localStorage.getItem('contagensEstoque')) || [];
            return contagens;
        }

        function salvarContagens(contagens) {
            localStorage.setItem('contagensEstoque', JSON.stringify(contagens));
            renderizarContagens();
        }

        function adicionarContagem(event) {
            event.preventDefault();
            
            if (isScanning) pararScanner();

            const localContagem = document.getElementById('campo-local-contagem').value; // NOVO CAMPO
            const codigoBruto = document.getElementById('campo-codigo-contagem').value;
            const codigoMaterial = extrairCodigoMaterial(codigoBruto);
            const nomeMaterial = document.getElementById('campo-nome-contagem').value;
            const dataContagem = document.getElementById('campo-data-contagem').value;
            const quantidade = parseFloat(document.getElementById('campo-quantidade-contagem').value);

            if (nomeMaterial.includes("N√ÉO ENCONTRADO") || codigoBruto.length === 0 || localContagem.length === 0) {
                alert("Erro: Preencha todos os campos, incluindo Local, ou verifique o C√≥digo do Material.");
                return;
            }

            const novaContagem = {
                id: Date.now(),
                local: localContagem, // NOVO CAMPO SALVO
                codigo: codigoMaterial,
                nome: nomeMaterial,
                data: dataContagem,
                quantidade: quantidade
            };

            const contagens = carregarContagens();
            contagens.push(novaContagem);
            salvarContagens(contagens);

            // Limpar o formul√°rio ap√≥s salvar
            document.getElementById('form-contagem').reset();
            document.getElementById('campo-data-contagem').value = new Date().toISOString().slice(0, 10);
            atualizarNomeMaterialContagem('');
            document.getElementById('mensagem-alerta').textContent = '';
        }

        function renderizarContagens() {
            const contagens = carregarContagens().reverse(); 
            const tabelaBody = document.querySelector('#tabela-contagens tbody');
            tabelaBody.innerHTML = '';
            
            document.getElementById('total-contagens').textContent = contagens.length;

            contagens.slice(0, 15).forEach(c => {
                const row = tabelaBody.insertRow();
                row.insertCell().textContent = c.local; // NOVO CAMPO EXIBIDO
                row.insertCell().textContent = c.codigo;
                row.insertCell().textContent = c.nome.substring(0, 30) + (c.nome.length > 30 ? '...' : ''); 
                row.insertCell().textContent = c.data;
                row.insertCell().textContent = c.quantidade;
            });
        }

        function limparContagens() {
            if (confirm("Tem certeza que deseja limpar todas as contagens salvas? Esta a√ß√£o √© irrevers√≠vel.")) {
                localStorage.removeItem('contagensEstoque');
                renderizarContagens();
                const dataAtual = new Date().toISOString().slice(0, 10);
                renderizarResumoPorData(dataAtual);
            }
        }
        
        // --- L√ìGICA DO RESUMO POR DATA (CONSOLIDADO) ---
        function renderizarResumoPorData(data) {
            const contagens = carregarContagens();
            const contagensDoDia = contagens.filter(c => c.data === data);
            const displayDiv = document.getElementById('layout-display-dinamico');
            displayDiv.innerHTML = '';

            if (contagensDoDia.length === 0) {
                displayDiv.innerHTML = `<p style="color: #f44336; font-weight: bold;">‚ö†Ô∏è Nenhuma contagem registrada para a data ${data}.</p>`;
                return;
            }

            // Agrupa as contagens por Local E C√≥digo do Material
            const resumoConsolidado = contagensDoDia.reduce((acc, contagem) => {
                const chave = `${contagem.local}|${contagem.codigo}`;
                acc[chave] = (acc[chave] || 0) + contagem.quantidade;
                return acc;
            }, {});

            let html = `<h4>Invent√°rio Consolidado para ${data}</h4>`;
            html += '<table id="tabela-resumo-consolidado">';
            html += '<thead><tr><th>Local/√Årea</th><th>C√≥d. Material</th><th>Nome do Material</th><th>Quantidade Contada</th></tr></thead><tbody>';

            for (const chave in resumoConsolidado) {
                const [local, codigo] = chave.split('|');
                const nome = BASE_ITENS[codigo] || "Material Desconhecido";
                const quantidadeTotal = resumoConsolidado[chave];
                
                html += `<tr>
                            <td>${local}</td>
                            <td>${codigo}</td>
                            <td>${nome}</td>
                            <td>${quantidadeTotal}</td>
                         </tr>`;
            }
            
            html += '</tbody></table>';
            html += '<p style="margin-top: 15px;">Este resumo agrupa as contagens do mesmo material feitas na mesma √°rea no dia selecionado.</p>';

            displayDiv.innerHTML = html;
        }


        // --- L√ìGICA DO SCANNER QR CODE (Revisada) ---
        
        const html5QrCode = new Html5Qrcode("leitor-qr-code");
        let isScanning = false;
        const btnScanner = document.getElementById('btn-scanner');

        function iniciarScanner() {
            // Adiciona um alerta para confirmar que a fun√ß√£o foi chamada
            alert("Tentando iniciar a c√¢mera. O navegador pedir√° permiss√£o.");

            const scannerDiv = document.getElementById('leitor-qr-code');
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            if (!isScanning) {
                html5QrCode.start(
                    { facingMode: "environment" }, // Prioriza a c√¢mera traseira em dispositivos m√≥veis
                    config,
                    (decodedText, decodedResult) => {
                        const inputCampo = document.getElementById('campo-codigo-contagem');
                        inputCampo.value = decodedText;
                        atualizarNomeMaterialContagem(decodedText); 
                        pararScanner();
                        alert(`QR Code lido: ${decodedText}`); 
                        document.getElementById('campo-quantidade-contagem').focus();
                    },
                    (errorMessage) => {
                        // Erro de decodifica√ß√£o (normal)
                    }
                ).catch((err) => {
                    // Este erro √© crucial para o diagn√≥stico:
                    alert("ERRO FATAL C√ÇMERA: Verifique se a p√°gina √© HTTPS, se a permiss√£o foi negada ou se a c√¢mera j√° est√° em uso por outro aplicativo/aba. Detalhe: " + err);
                    isScanning = false;
                    btnScanner.textContent = "Abrir C√¢mera (QR Code) üì∑";
                });
                
                isScanning = true;
                scannerDiv.style.display = 'block';
                btnScanner.textContent = "Fechar C√¢mera";

            } else {
                pararScanner();
            }
        }

        function pararScanner() {
            if (isScanning) {
                html5QrCode.stop().then((ignore) => {
                    document.getElementById('leitor-qr-code').style.display = 'none';
                    isScanning = false;
                    btnScanner.textContent = "Abrir C√¢mera (QR Code) üì∑";
                }).catch((err) => {
                    console.error("Erro ao parar o scanner.", err);
                    isScanning = false;
                    btnScanner.textContent = "Abrir C√¢mera (QR Code) üì∑";
                });
            }
        }
        
        // --- INICIALIZA√á√ÉO DA P√ÅGINA ---

        document.addEventListener('DOMContentLoaded', () => {
            const dataAtual = new Date().toISOString().slice(0, 10);
            document.getElementById('campo-data-contagem').value = dataAtual;
            document.getElementById('filtro-data-layout').value = dataAtual;

            renderizarContagens();
        });
    </script>
</body>
</html>
