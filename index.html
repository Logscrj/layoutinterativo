<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contagem e Layout de Estoque</title>
    
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        /* --- Estilos de Navega√ß√£o (Abas) --- */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            overflow-x: auto; /* Permite rolar em telas pequenas */
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #f4f4f9;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 3px solid #2196F3;
            color: #2196F3;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* --- Estilos do Formul√°rio/Contagem/Layout --- */
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            margin-top: 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-registrar {
            background-color: #4CAF50;
            color: white;
            width: 100%;
        }
        #btn-scanner, #btn-salvar-layout {
            background-color: #2196F3;
            color: white;
            width: 100%;
            margin-bottom: 10px;
            margin-top: 5px; 
        }
        .alerta {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        #leitor-qr-code {
            width: 100%;
            margin-top: 10px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            display: none; 
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        table th {
            background-color: #f2f2f2;
        }
        .layout-input {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Sistema de Invent√°rio</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('tab-registrar', this)">1. Registrar Contagem üìù</button>
            <button class="tab-button" onclick="showTab('tab-layout-manual', this)">2. Layout Manual (Config) ‚öôÔ∏è</button>
            <button class="tab-button" onclick="showTab('tab-layout-contagem', this)">3. Layout por Data (Real) üìä</button>
        </div>

        <div id="tab-registrar" class="tab-content active">
            <h2>Registrar Nova Contagem de Estoque</h2>
            <form id="form-contagem" onsubmit="adicionarContagem(event)">

                <label for="campo-codigo-contagem">C√≥digo do Material (QR Code ou Digitar):</label>
                <input type="text" id="campo-codigo-contagem" oninput="atualizarNomeMaterialContagem(this.value)" required>
                
                <button type="button" id="btn-scanner" onclick="iniciarScanner()">
                    Abrir C√¢mera (QR Code) üì∑
                </button>
                <div id="leitor-qr-code"></div>
                
                <p id="nome-material-contagem" style="margin-top: 5px; font-style: italic; color: #555;">Nome do Material: N/A</p>
                <input type="hidden" id="campo-nome-contagem" value="">
                
                <label for="campo-data-contagem">Data da Contagem:</label>
                <input type="date" id="campo-data-contagem" value="" required>

                <label for="campo-quantidade-contagem">Quantidade Contada:</label>
                <input type="number" step="any" id="campo-quantidade-contagem" value="0" min="0" required>
                
                <button type="submit" id="btn-registrar">Registrar Contagem</button>
                <p id="mensagem-alerta" class="alerta"></p>
            </form>

            <hr>
            <h3>Contagens Registradas (Total: <span id="total-contagens">0</span>)</h3>
            <table id="tabela-contagens">
                <thead>
                    <tr>
                        <th>C√≥d.</th>
                        <th>Nome Material</th>
                        <th>Data</th>
                        <th>Qtd.</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button onclick="limparContagens()" style="background-color: #f44336; color: white;">Limpar Todas as Contagens</button>
        </div>

        <div id="tab-layout-manual" class="tab-content">
            <h2>Configura√ß√£o Manual do Layout (Capacidade e Material Padr√£o)</h2>
            <p>Edite a capacidade (vagas) e o material padr√£o para cada √°rea/rua. Clique em "Salvar Configura√ß√£o" ap√≥s as altera√ß√µes.</p>
            
            <button type="button" id="btn-salvar-layout" onclick="salvarConfiguracaoLayout()">
                Salvar Configura√ß√£o de Layout üíæ
            </button>

            <table id="tabela-layout-manual">
                <thead>
                    <tr>
                        <th style="width: 25%;">√Årea/Rua</th>
                        <th style="width: 20%;">Capacidade (Vagas)</th>
                        <th style="width: 45%;">Material Padr√£o</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            
        </div>

        <div id="tab-layout-contagem" class="tab-content">
            <h2>Layout com Ocupa√ß√£o por Data (Invent√°rio Real)</h2>
            <p>Aqui voc√™ ver√° o resumo da ocupa√ß√£o real baseado nas contagens registradas.</p>
            
            <label for="filtro-data-layout">Filtrar Ocupa√ß√£o pela Data:</label>
            <input type="date" id="filtro-data-layout" onchange="renderizarLayoutPorData(this.value)">

            <div id="layout-display-dinamico" style="margin-top: 15px;">
                </div>
        </div>

    </div>

    <script>
        // --- BASE DE DADOS E L√ìGICA DO INVENT√ÅRIO ---
        
        const BASE_ITENS = {
            // C√≥digo Limpo (sem prefixo Q000) : Nome do Material
            "92983": "CH V GYP ST BR12,5-120X180",
            "92993": "CH V GYP ST BR12.5-120X240", 
            "4577023": "GESSO RECICLADO",
            "313665": "CH GYP GWD BR12,5-120X240",
            "142685": "SUPERBOARD ST BQ 6MM 1200X2400",
            "4066969": "FIX IB GYP TB 3,5X25 CX 1.000",
            "4094219": "ACAB R GYP GWD TELA P/JUNTAS 20CMX50M RL",
            "140358": "CH V GYP ST BR6,4-120X240",
            "142687": "SUPERBOARD ST BQ 10MM 1200X2400",
            "93018": "CH V GYP ST BR12,5-120X270",
            "304393": "CH V PROMAPRO+ RF BR15,0-120X240",
            "4066968": "FIX IB GYP TA 3,5X45 CX 500",
            "93022": "CH V GYP ST BR12,5-120X240",
            // Adicione mais itens conforme seu arquivo
        };
        
        // --- CONFIGURA√á√ÉO INICIAL DO LAYOUT MANUAL ---
        const CONFIGURACAO_INICIAL_LAYOUT = [
            { area: "Rua 1", produto: "92983", capacidade: 10, capacidade_original: 10 },
            { area: "Rua 2", produto: "92993", capacidade: 10, capacidade_original: 10 },
            { area: "Rua 3", produto: "142685", capacidade: 8, capacidade_original: 8 },
            { area: "Doca Ext 1", produto: "4577023", capacidade: 5, capacidade_original: 5 },
            { area: "Doca Ext 2", produto: "4577023", capacidade: 5, capacidade_original: 5 },
            { area: "P√°tio A", produto: "304393", capacidade: 20, capacidade_original: 20 },
            // Adicione mais √°reas/ruas conforme a sua necessidade
        ];

        function showTab(tabId, button) {
            // Oculta todas as abas
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Desativa todos os bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostra a aba desejada
            document.getElementById(tabId).classList.add('active');
            // Ativa o bot√£o
            button.classList.add('active');
            
            // Renderiza o conte√∫do da aba Layout Manual quando ela √© aberta
            if (tabId === 'tab-layout-manual') {
                renderizarLayoutManual();
            }
            if (tabId === 'tab-layout-contagem') {
                const dataAtual = new Date().toISOString().slice(0, 10);
                document.getElementById('filtro-data-layout').value = dataAtual;
                renderizarLayoutPorData(dataAtual);
            }
        }

        // --- FUN√á√ïES GERAIS ---

        function extrairCodigoMaterial(codigoBruto) {
            const match = codigoBruto.match(/Q00060(\d+)/);
            if (match && match[1]) {
                return match[1];
            }
            return codigoBruto; 
        }

        function atualizarNomeMaterialContagem(codigoBruto) {
            const codigo = extrairCodigoMaterial(codigoBruto);
            const nome = BASE_ITENS[codigo] || "N√ÉO ENCONTRADO na base de itens.";
            
            document.getElementById('nome-material-contagem').textContent = `Nome do Material: ${nome}`;
            document.getElementById('campo-nome-contagem').value = nome;
            
            const alerta = document.getElementById('mensagem-alerta');
            if (!BASE_ITENS[codigo] && codigoBruto.length > 0) {
                alerta.textContent = "‚ö†Ô∏è C√≥digo n√£o encontrado. Verifique a base de dados.";
            } else {
                alerta.textContent = "";
            }
        }
        
        // --- L√ìGICA DE CONTROLE DE DADOS (Contagens) ---
        
        function carregarContagens() {
            const contagens = JSON.parse(localStorage.getItem('contagensEstoque')) || [];
            return contagens;
        }

        function salvarContagens(contagens) {
            localStorage.setItem('contagensEstoque', JSON.stringify(contagens));
            renderizarContagens();
        }

        function adicionarContagem(event) {
            event.preventDefault();
            
            if (isScanning) pararScanner();

            const codigoBruto = document.getElementById('campo-codigo-contagem').value;
            const codigoMaterial = extrairCodigoMaterial(codigoBruto);
            const nomeMaterial = document.getElementById('campo-nome-contagem').value;
            const dataContagem = document.getElementById('campo-data-contagem').value;
            const quantidade = parseFloat(document.getElementById('campo-quantidade-contagem').value);

            if (nomeMaterial.includes("N√ÉO ENCONTRADO") || codigoBruto.length === 0) {
                alert("Erro: O material n√£o foi encontrado ou o campo C√≥digo do Material est√° vazio. Registre apenas materiais v√°lidos.");
                return;
            }

            const novaContagem = {
                id: Date.now(),
                codigo: codigoMaterial,
                nome: nomeMaterial,
                data: dataContagem,
                quantidade: quantidade
            };

            const contagens = carregarContagens();
            contagens.push(novaContagem);
            salvarContagens(contagens);

            // Limpar o formul√°rio ap√≥s salvar
            document.getElementById('form-contagem').reset();
            document.getElementById('campo-data-contagem').value = new Date().toISOString().slice(0, 10);
            atualizarNomeMaterialContagem('');
            document.getElementById('mensagem-alerta').textContent = '';
        }

        function renderizarContagens() {
            const contagens = carregarContagens().reverse(); 
            const tabelaBody = document.querySelector('#tabela-contagens tbody');
            tabelaBody.innerHTML = '';
            
            document.getElementById('total-contagens').textContent = contagens.length;

            contagens.slice(0, 15).forEach(c => { // Mostra os 15 mais recentes
                const row = tabelaBody.insertRow();
                row.insertCell().textContent = c.codigo;
                row.insertCell().textContent = c.nome.substring(0, 30) + (c.nome.length > 30 ? '...' : ''); 
                row.insertCell().textContent = c.data;
                row.insertCell().textContent = c.quantidade;
            });
        }

        function limparContagens() {
            if (confirm("Tem certeza que deseja limpar todas as contagens salvas? Esta a√ß√£o √© irrevers√≠vel.")) {
                localStorage.removeItem('contagensEstoque');
                renderizarContagens();
                const dataAtual = new Date().toISOString().slice(0, 10);
                renderizarLayoutPorData(dataAtual);
            }
        }
        
        // --- L√ìGICA DE CONTROLE DE DADOS (Layout Manual) ---
        
        function carregarConfiguracaoLayout() {
            const config = JSON.parse(localStorage.getItem('layoutConfig')) || CONFIGURACAO_INICIAL_LAYOUT;
            return config;
        }

        function salvarConfiguracaoLayout() {
            const tabelaBody = document.querySelector('#tabela-layout-manual tbody');
            const linhas = tabelaBody.querySelectorAll('tr');
            const novaConfiguracao = [];

            linhas.forEach(row => {
                const area = row.cells[0].textContent.trim();
                const capacidade = parseInt(row.querySelector('.input-capacidade').value) || 0;
                const produto = row.querySelector('.input-produto').value.trim();
                
                novaConfiguracao.push({ area, produto, capacidade, capacidade_original: capacidade });
            });
            
            localStorage.setItem('layoutConfig', JSON.stringify(novaConfiguracao));
            alert("Configura√ß√£o de Layout Salva com Sucesso!");
        }

        function renderizarLayoutManual() {
            const config = carregarConfiguracaoLayout();
            const tabelaBody = document.querySelector('#tabela-layout-manual tbody');
            tabelaBody.innerHTML = '';

            config.forEach((item, index) => {
                const row = tabelaBody.insertRow();
                
                // C√©lula 1: √Årea/Rua (N√£o edit√°vel)
                row.insertCell().textContent = item.area;
                
                // C√©lula 2: Capacidade (Edit√°vel)
                const cellCapacidade = row.insertCell();
                cellCapacidade.innerHTML = `<input type="number" class="layout-input input-capacidade" value="${item.capacidade}" min="0" onchange="document.getElementById('btn-salvar-layout').style.backgroundColor='#f44336'">`;
                
                // C√©lula 3: Material Padr√£o (Edit√°vel - C√≥digo do Material)
                const cellProduto = row.insertCell();
                const nomeProduto = BASE_ITENS[item.produto] || "C√≥digo Inv√°lido";
                cellProduto.innerHTML = `
                    <input type="text" class="layout-input input-produto" value="${item.produto}" oninput="mostrarNomeProdutoManual(this, ${index})" onchange="document.getElementById('btn-salvar-layout').style.backgroundColor='#f44336'">
                    <small id="produto-nome-${index}" style="display: block; margin-top: 3px; font-style: italic; color: ${nomeProduto === 'C√≥digo Inv√°lido' ? 'red' : '#555'};">${nomeProduto}</small>
                `;
            });
            
            document.getElementById('btn-salvar-layout').style.backgroundColor='#2196F3'; // Volta a cor padr√£o se renderizar sem mudan√ßas

        }
        
        function mostrarNomeProdutoManual(inputElement, index) {
            const codigo = inputElement.value.trim();
            const nome = BASE_ITENS[codigo] || "C√≥digo Inv√°lido";
            const smallElement = document.getElementById(`produto-nome-${index}`);
            
            smallElement.textContent = nome;
            smallElement.style.color = nome === 'C√≥digo Inv√°lido' ? 'red' : '#555';
        }

        // --- L√ìGICA DO LAYOUT POR DATA (REAL) ---
        function renderizarLayoutPorData(data) {
            const contagens = carregarContagens();
            const contagensDoDia = contagens.filter(c => c.data === data);
            const configLayout = carregarConfiguracaoLayout();
            const displayDiv = document.getElementById('layout-display-dinamico');
            displayDiv.innerHTML = '';

            if (contagensDoDia.length === 0) {
                displayDiv.innerHTML = `<p style="color: #f44336; font-weight: bold;">‚ö†Ô∏è Nenhuma contagem registrada para a data ${data}.</p>`;
                return;
            }

            // 1. Agrupa as contagens por c√≥digo de material
            const resumoContagem = contagensDoDia.reduce((acc, contagem) => {
                acc[contagem.codigo] = (acc[contagem.codigo] || 0) + contagem.quantidade;
                return acc;
            }, {});

            // 2. Cria a tabela de compara√ß√£o (Configurado vs Real)
            let html = `<h4>Compara√ß√£o do Invent√°rio Real vs Configura√ß√£o (${data})</h4>`;
            html += '<table id="tabela-comparacao-layout">';
            html += '<thead><tr><th>√Årea/Rua</th><th>Mat. Padr√£o</th><th>Capac. (Vagas)</th><th>Qtd. Contada</th><th>Status</th></tr></thead><tbody>';

            configLayout.forEach(itemConfig => {
                const qtdContada = resumoContagem[itemConfig.produto] || 0;
                const nomeProdutoConfig = BASE_ITENS[itemConfig.produto] || "Inv√°lido";
                
                // L√≥gica de Status: Simples compara√ß√£o entre capacidade e o que foi contado para o material padr√£o daquela √°rea
                let status, cor;
                if (qtdContada > itemConfig.capacidade) {
                    status = `ACIMA da Capacidade (${qtdContada - itemConfig.capacidade} a mais)`;
                    cor = '#f44336'; // Vermelho
                } else if (qtdContada > 0 && qtdContada <= itemConfig.capacidade) {
                    status = `Ocupado (${itemConfig.capacidade - qtdContada} Vagas Livres)`;
                    cor = '#4CAF50'; // Verde
                } else if (qtdContada === 0) {
                    status = `LIVRE (Vazio)`;
                    cor = '#ff9800'; // Amarelo/Laranja
                } else {
                    status = `Sem Contagem Relevante`;
                    cor = '#9e9e9e'; // Cinza
                }
                
                html += `<tr>
                            <td>${itemConfig.area}</td>
                            <td>${nomeProdutoConfig} (${itemConfig.produto})</td>
                            <td>${itemConfig.capacidade}</td>
                            <td>${qtdContada}</td>
                            <td style="color: white; background-color: ${cor}; font-weight: bold;">${status}</td>
                         </tr>`;
            });
            
            html += '</tbody></table>';
            html += '<p style="margin-top: 15px;">*O Status compara a quantidade contada do MATERIAL PADR√ÉO da √°rea com a Capacidade definida.</p>';

            displayDiv.innerHTML = html;
        }


        // --- L√ìGICA DO SCANNER QR CODE (CORRIGIDA) ---
        
        const html5QrCode = new Html5Qrcode("leitor-qr-code");
        let isScanning = false;
        const btnScanner = document.getElementById('btn-scanner');

        function iniciarScanner() {
            const scannerDiv = document.getElementById('leitor-qr-code');
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            if (!isScanning) {
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText, decodedResult) => {
                        const inputCampo = document.getElementById('campo-codigo-contagem');
                        inputCampo.value = decodedText;
                        atualizarNomeMaterialContagem(decodedText); 
                        pararScanner();
                        alert(`QR Code lido: ${decodedText}`); 
                        document.getElementById('campo-quantidade-contagem').focus();
                    },
                    (errorMessage) => {
                        // Erro de decodifica√ß√£o
                    }
                ).catch((err) => {
                    alert("Erro ao iniciar a c√¢mera. Verifique as permiss√µes do navegador e se o dispositivo tem c√¢mera. " + err);
                    isScanning = false;
                    btnScanner.textContent = "Abrir C√¢mera (QR Code) üì∑";
                });
                
                isScanning = true;
                scannerDiv.style.display = 'block';
                btnScanner.textContent = "Fechar C√¢mera";

            } else {
                pararScanner();
            }
        }

        function pararScanner() {
            if (isScanning) {
                html5QrCode.stop().then((ignore) => {
                    document.getElementById('leitor-qr-code').style.display = 'none';
                    isScanning = false;
                    btnScanner.textContent = "Abrir C√¢mera (QR Code) üì∑";
                }).catch((err) => {
                    console.error("Erro ao parar o scanner.", err);
                    isScanning = false;
                    btnScanner.textContent = "Abrir C√¢mera (QR Code) üì∑";
                });
            }
        }
        
        // --- INICIALIZA√á√ÉO DA P√ÅGINA ---

        document.addEventListener('DOMContentLoaded', () => {
            // Define a data atual nos campos
            const dataAtual = new Date().toISOString().slice(0, 10);
            document.getElementById('campo-data-contagem').value = dataAtual;
            document.getElementById('filtro-data-layout').value = dataAtual;

            // Carrega as contagens salvas
            renderizarContagens();
        });
    </script>
</body>
</html>
