<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Etex STC - Sistema de Vagas de Estoque</title>
    <style>
        /* Estilos CSS (Cores: Laranja e Preto) */
        :root {
            --cor-principal: #FF8C00; /* Laranja Vívido */
            --cor-secundaria: #1E1E1E; /* Preto Quase Total */
            --cor-fundo: #F5F5F5; /* Fundo Claro para contraste */
            --cor-texto: #FFFFFF; /* Texto em destaque */
            --cor-texto-principal: #1E1E1E;
            --cor-ocupado: #FFD700; /* Dourado/Amarelo para Ocupação */
            --cor-vazio: #333333; /* Cinza Escuro para Vazio */
            --cor-contagem: #1e87f0; /* Azul para destaque da contagem */
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-principal);
        }

        header {
            background-color: var(--cor-secundaria);
            color: var(--cor-texto);
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid var(--cor-principal);
        }

        main {
            padding: 20px;
        }

        /* --- Dashboard de Ocupação --- */
        #dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card-dashboard {
            background-color: var(--cor-secundaria);
            color: var(--cor-texto);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
            border: 1px solid var(--cor-principal);
        }

        .card-dashboard h3 {
            margin-top: 0;
            color: var(--cor-principal);
            font-size: 1.1em;
        }

        .progress-bar-container {
            background-color: var(--cor-vazio);
            border-radius: 5px;
            margin-top: 5px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--cor-principal);
            text-align: right;
            line-height: 20px;
            color: var(--cor-secundaria);
            font-weight: bold;
            transition: width 0.5s ease-in-out;
            padding-right: 5px;
            box-sizing: border-box;
        }

        /* --- Layout de Áreas (em Tabela, como planilha) --- */
        #layout-areas, #layout-contado-areas {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .area {
            background-color: #ffffff;
            border: 2px solid var(--cor-secundaria);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .area h2 {
            color: var(--cor-principal);
            border-bottom: 2px solid var(--cor-principal);
            padding-bottom: 5px;
            margin-top: 0;
            cursor: pointer;
        }

        .area-contada h2 {
             color: var(--cor-contagem);
             border-bottom: 2px solid var(--cor-contagem);
        }

        .tabela-vagas {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .tabela-vagas th, .tabela-vagas td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .tabela-vagas th {
            background-color: var(--cor-secundaria);
            color: var(--cor-texto);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85em;
            white-space: nowrap; /* Evita quebra de linha no cabeçalho */
        }
        
        /* Cabeçalho da Tabela Contada (Diferente) */
        .tabela-vagas.contado th {
            background-color: var(--cor-contagem);
        }

        /* Linha da Vaga */
        .tabela-vagas tr {
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tabela-vagas tr:hover {
            background-color: #ffe8cc; /* Cor de hover suave */
        }
        
        .tabela-vagas.contado tr:hover {
             background-color: #e0f2ff; /* Cor de hover suave azul */
        }

        .vaga-ocupada {
            background-color: #fff7e6; /* Fundo mais claro para ocupadas */
        }
        
        .vaga-contada {
            background-color: #f0f8ff; /* Fundo mais claro para contadas */
        }
        
        /* Estilos de Status */
        .status-liberado { color: #28a745; font-weight: bold; }
        .status-na-fila-do-fifo { color: #007bff; font-weight: bold; }
        .status-bloqueado, .status-bloqueado-qa { color: #dc3545; font-weight: bold; }
        .status-em-cura { color: #ffc107; font-weight: bold; }
        .status-contado { color: var(--cor-contagem); font-weight: bold; }

        /* --- Interface de Contagem (Formulário) --- */
        #interface-contagem {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }
        
        #form-contagem label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        #form-contagem input,
        #form-contagem select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #form-contagem button {
            background-color: var(--cor-contagem);
            color: var(--cor-texto);
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        #form-contagem button:hover {
            background-color: #1260a5;
        }
        
         .nome-material-contagem {
             font-style: italic;
             color: #666;
             margin-top: 5px;
             display: block;
         }
         
         .contagem-message {
             padding: 10px;
             margin-top: 15px;
             border-radius: 4px;
             font-weight: bold;
         }
         
         .success {
             background-color: #d4edda;
             color: #155724;
             border: 1px solid #c3e6cb;
         }
         
         /* NOVO: Estilo para o filtro de data */
         #filtro-contagem-container {
             background-color: #e0f2ff; 
             padding: 15px; 
             border-radius: 4px;
             margin-bottom: 20px;
             border: 1px solid var(--cor-contagem);
         }
         
         #data-filtro-contagem {
             padding: 8px; 
             border: 1px solid #ccc; 
             border-radius: 4px; 
             margin-left: 10px;
         }


    </style>
    <script>
        // --- Base de Dados de Itens do Estoque (COMPLETA) ---
        // CLASSIFICADA COM BASE NO PDF FORNECIDO PELO USUÁRIO.
        const BASE_ITENS = {
            
            // ===========================================
            // 1. PLACAS DE GESSO (STANDARD, RU, RF, TOP)
            // ===========================================
            // Placas 12,5mm (ST - Standard)
            "92983": { nome: "CH V GYP ST BR12,5-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" }, 
            "92986": { nome: "CH V GYP ST BR12,5-120X200", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94443": { nome: "CH V GYP ST BR12,5-120X200 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92989": { nome: "CH V GYP ST BR12,5-120X220", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94444": { nome: "CH V GYP ST BR12,5-120X220 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92991": { nome: "CH V GYP ST BR12,5-120X225", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92992": { nome: "CH V GYP ST BR12,5-120X230", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "294723": { nome: "CH V GYP ST BR12,5-120X230 OG", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92993": { nome: "CH V GYP ST BR12.5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92999": { nome: "CH V GYP ST BR12,5-120X250", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93003": { nome: "CH V GYP ST BR12,5-120X255", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "175304": { nome: "CH V GYP ST BR12,5-120X255 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93008": { nome: "CH V GYP ST BR12,5-120X260", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94458": { nome: "CH V GYP ST BR12,5-120X260 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93009": { nome: "CH V GYP ST BR12,5-120X261", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94460": { nome: "CH V GYP ST BR12,5-120X261 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "259325": { nome: "CH V GYP ST BR12,5-120X262 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93012": { nome: "CH V GYP ST BR12,5-120X264", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93013": { nome: "CH V GYP ST BR12,5-120X265", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93014": { nome: "CH V GYP ST BR12,5-120X266", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93018": { nome: "CH V GYP ST BR12,5-120X270", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94461": { nome: "CH V GYP ST BR12,5-120X270 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140462": { nome: "CH V GYP ST BR12,5-120X271", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "145875": { nome: "CH V GYP ST BR12,5-120X271(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "95763": { nome: "CH V GYP ST BR12,5-120X269 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93022": { nome: "CH V GYP ST BR12,5-120X275", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93025": { nome: "CH V GYP ST BR12,5-120X280", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94462": { nome: "CH V GYP ST BR12,5-120X280 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "175310": { nome: "CH V GYP ST BR12,5-120X285(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93031": { nome: "CH V GYP ST BR12,5-120X290", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94463": { nome: "CH V GYP ST BR12,5-120X290 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "163301": { nome: "CH V GYP ST BR12,5-120X292 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "302412": { nome: "CH V GYP ST BR12,5-120X298", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "93035": { nome: "CH V GYP ST BR12,5-120X300", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94474": { nome: "CH V GYP ST BR12,5-120X300 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            
            // Placas 15,0mm (ST - Standard)
            "140373": { nome: "CH V GYP RF BR15-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140463": { nome: "CH V GYP ST BR15,0-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "165700": { nome: "CH V GYP ST BR15,0-120X180 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140371": { nome: "CH V GYP ST BR15,0-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "167801": { nome: "CH V GYP ST BR15,0-120X240(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "158405": { nome: "CH V GYP ST BR15,0-120X260", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "175306": { nome: "CH V GYP ST BR15,0-120X260(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "143720": { nome: "CH V GYP ST BR15,0-120X271", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "163225": { nome: "CH V GYP ST BR15,0-120X271 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "281635": { nome: "CH V GYP ST BR15,0-120X270", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "213619": { nome: "CH V GYP ST BR15,0-120X300", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "300659": { nome: "CH V GYP ST15,0-120X300 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            
            // Placas (RU - Resistente à Umidade)
            "92939": { nome: "CH V GYP RU BR12,5-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94476": { nome: "CH V GYP RU BR12,5-120X180 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92940": { nome: "CH V GYP RU BR12,5-120X200", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94478": { nome: "CH V GYP RU BR12,5-120X200 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94172": { nome: "CH V GYP RU BR12,5-120X210", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92941": { nome: "CH V GYP RU BR12,5-120X220", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94479": { nome: "CH V GYP RU BR12,5-120X220 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92943": { nome: "CH V GYP RU BR12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94477": { nome: "CH V GYP RU BR12,5-120X240 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92946": { nome: "CH V GYP RU BR12,5-120X250", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "145094": { nome: "CH V GYP RU BR12,5-120X250 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92950": { nome: "CH V GYP RU BR12,5-120X255", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "188282": { nome: "CH V GYP RU BR12,5-120X255 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92954": { nome: "CH V GYP RU BR12,5-120X260", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92955": { nome: "CH V GYP RU BR12,5-120X261", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94500": { nome: "CH V GYP RU BR12,5-120X261 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "259326": { nome: "CH V GYP RU BR12,5-120X262 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92959": { nome: "CH V GYP RU BR12,5-120X265", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92960": { nome: "CH V GYP RU BR12,5-120X266", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "291286": { nome: "CH V GYP RU BR12,5-120X266(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92964": { nome: "CH V GYP RU BR12,5-120X270", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94501": { nome: "CH V GYP RU BR12,5-120X270 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92966": { nome: "CH V GYP RU BR12,5-120X273", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92967": { nome: "CH V GYP RU BR12,5-120X275", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "95762": { nome: "CH V GYP RU BR12,5-120X275 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "167805": { nome: "CH V GYP RU BR12,5-120X271(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92970": { nome: "CH V GYP RU BR12,5-120X280", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94520": { nome: "CH V GYP RU BR12,5-120X280 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "92975": { nome: "CH V GYP RU BR12,5-120X290", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94521": { nome: "CH V GYP RU BR12,5-120X290 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "94522": { nome: "CH V GYP RU BR12,5-120X300 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140464": { nome: "CH V GYP RU BR15-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "145093": { nome: "CH V GYP RU BR15-120X180 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "163303": { nome: "CH V GYP RU BR15-120X240 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "158404": { nome: "CH V GYP RU BR15-120X260", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "188283": { nome: "CH V GYP RU BR15-120X260 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            
            // Placas (RF - Resistente a Fogo)
            "140363": { nome: "CH V GYP RF BR12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "145098": { nome: "CH V GYP RF BR12,5-120X240 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140365": { nome: "CH V GYP RF BR12,5-120X260", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "299782": { nome: "CH V GYP RF BR12,5-120X275", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140368": { nome: "CH V GYP RF BR12,5-120X280", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "188284": { nome: "CH V GYP RF BR12,5-120X280 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140370": { nome: "CH V GYP RF BR12,5-120X300", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "145097": { nome: "CH V GYP RF BR12,5-120X180 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140372": { nome: "CH V GYP RF BR15-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "145099": { nome: "CH V GYP RF BR15-120X180 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "140374": { nome: "CH V GYP RF BR15-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "163302": { nome: "CH V GYP RF BR15-120X240 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "276142": { nome: "CH V GYP RF BR15-120X208", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "175992": { nome: "CH V GYP RF BR15-120X220", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "299858": { nome: "CH V GYP RF BR15-120X260", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "175991": { nome: "CH V GYP RF BR15-120X270", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "249130": { nome: "CH V GYP RF BR15-120X270 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "157499": { nome: "CH V GYP RF BR15-120X280", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "160285": { nome: "CH V GYP RF BR15-120X300", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "175308": { nome: "CH V GYP RF BR15-120X300(OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            
            // Outros Tipos de Placa de Gesso (Acoustic, Small, PROMAPRO+)
            "168668": { nome: "CH V GYP ST TOP BR12,5-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "187780": { nome: "CH V GYP ST TOP BR12,5-120X180 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "287782": { nome: "CH V GYP ST TOP BR12,5-120X200", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "295816": { nome: "CH V GYP ST TOP BR12,5-120X200 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "254570": { nome: "CH V GYP ST TOP BR12,5-120X220", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "279128": { nome: "CH V GYP ST TOP BR12,5-1,20X220 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "307172": { nome: "CH V GYP TOP RU BR12,5-120X180", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "304393": { nome: "CH V PROMAPRO+ RF BR15,0-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "304394": { nome: "SFCV4 CH V PROMAPRO+ RF BR15,0-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "310191": { nome: "CH V GYP PROMAPRO+ RF12,5 BR12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "315003": { nome: "CH V GYP PROMAPRO+ RF12,5 BR12,5-120X220", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "133559": { nome: "CHI SOM Q8N8 BR 12,5-1,20 X 2,40", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "162975": { nome: "CHI SOM Q12/25 BQ12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "162976": { nome: "CHI SOM R12/25 BQ12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "162977": { nome: "CH I SOM RA8/15 BQ12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "146303": { nome: "CHI SOM R15N1 BR12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "146301": { nome: "CHI SOM R15N8 BR12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "313665": { nome: "CH GYP GWD BR12,5-120X240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "156838": { nome: "PLACA GYPSUM EST REF 12,5MM 1,20 X 2,4M", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "291194": { nome: "PLACA GYPLAC ST 1220X2440X12,7", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "292937": { nome: "PLACA GYPLAC ST 1220X2440X12,7 EB RXO", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "133846": { nome: "CHI GYP AQUABOARD BR12,5-120x240", tipo: "PLACA DE GESSO (ST/RU/RF)" },
            "295969": { nome: "CH I GYP AQUABOARD BR12,5-120X240 (OG)", tipo: "PLACA DE GESSO (ST/RU/RF)" },

            // ===========================================
            // 2. PLACAS CIMENTÍCIAS E ESPECIAIS
            // ===========================================
            "142685": { nome: "SUPERBOARD ST BQ 6MM 1200X2400", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142686": { nome: "SUPERBOARD ST BQ 8MM 1200X2400", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "160254": { nome: "SUPERBOARD ST BQ 8MM 1200X2400 (OG)", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142687": { nome: "SUPERBOARD ST BQ 10MM 1200X2400", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142676": { nome: "SUPERBOARD ST BQ 10MM 1200X3000", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "295418": { nome: "SUPERBOARD ST BQ 10MM 1200X3000 OG", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142678": { nome: "SUPERBOARD ST BQ 12MM 1200X2400", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "240038": { nome: "SUPERBOARD ST BQ 12MM 1200X2400 OG", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142087": { nome: "SUPERBOARD SIDING LISO 200X2440X8MM BR", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142089": { nome: "SUPERBOARD SIDING MADERA 200X2440X8MM BR", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142109": { nome: "SUPERBOARD MADERA 1220X2440X8MM BR", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "175305": { nome: "SUPERBOARD MADERA 1220X2440X8MM BR(OG)", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142677": { nome: "SUPERBOARD PRO BR 8MM 1200X2400", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "167804": { nome: "SUPERBOARD PRO BR 10MM 120X240(OG)", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "142084": { nome: "SUPERBOARD PRO BR 10MM 120X240", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "163927": { nome: "SUPERBOARD ESTANDAR 1220X2540X4MM BR", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "149934": { nome: "SUPERBOARD ST BQ 4mm 1220 X 2520", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "216265": { nome: "SUPERBOARD ST (BQ) 4MM 1,20M x 2,40M", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "224912": { nome: "SUPERBOARD IA ST (BQ) 6MM 1,20M x 2,40M", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "224913": { nome: "SUPERBOARD IA ST (BQ) 8MM 1,20M x 2,40M", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "224915": { nome: "SUPERBOARD IA ST (BQ) 10MM 1,20M x 2,40M", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "88043": { nome: "SUPERBOARD 2M40X1M20 10MM BORDA RETA", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "143016": { nome: "SUPERBOARD ENTREPISO 1220X2440X14 MM BR", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "111551": { nome: "PROMASTOPW -18m-coil 1 pc/box", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "49060": { nome: "PROMASTOP UNICOLLAR EXPORT 2250X50X12MM", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "291246": { nome: "PROMATECT H12 mm 1200X2400 mm (OG)", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "81975": { nome: "CEDRAL SIDING LISO NATURAL 2M40X0M20X8MM", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "168156": { nome: "MTO CEDRAL TRACE 3150X175X20 R EDG TR05", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "168171": { nome: "MTO CEDRAL TRACE 3150X175X20 TR05", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },
            "168176": { nome: "MTO CEDRAL TRACE 3150X84,5X20 TR05", tipo: "PLACA CIMENTÍCIA/ESPECIAL" },

            // ===========================================
            // 3. ACESSÓRIOS E PERFIS
            // ===========================================
            // Fixadores e Parafusos
            "4066966": { nome: "FIX IB GYP TA 3,5X25 CX 1.000", tipo: "ACESSÓRIOS E PERFIS" },
            "4066968": { nome: "FIX IB GYP TA 3,5X45 CX 500", tipo: "ACESSÓRIOS E PERFIS" },
            "4066969": { nome: "FIX IB GYP TB 3,5X25 CX 1.000", tipo: "ACESSÓRIOS E PERFIS" },
            "4066970": { nome: "FIX IB GYP LB 4,2X13 CX 1.000", tipo: "ACESSÓRIOS E PERFIS" },
            "4084641": { nome: "FIX GYP AQ TAHL 3,5X32 CX 400", tipo: "ACESSÓRIOS E PERFIS" },
            
            // Fitas e Telas
            "4043834": { nome: "FITA CT 30M", tipo: "ACESSÓRIOS E PERFIS" },
            "4043835": { nome: "FITA JT 150 M CX 10", tipo: "ACESSÓRIOS E PERFIS" },
            "4043836": { nome: "ACAB R GYP FITA 48 BANDA A 10 CX 10", tipo: "ACESSÓRIOS E PERFIS" },
            "4043837": { nome: "ACAB R GYP FITA 70 BANDA A 10 CX 10", tipo: "ACESSÓRIOS E PERFIS" },
            "4043838": { nome: "ACAB R GYP FITA 90 BANDA A 10 CX 10", tipo: "ACESSÓRIOS E PERFIS" },
            "4094219": { nome: "ACAB R GYP GWD TELA P/JUNTAS 20CMX50M RL", tipo: "ACESSÓRIOS E PERFIS" },
            "4094217": { nome: "ACAB R GYP GWD TELA BASECOAT 1MX50M RL", tipo: "ACESSÓRIOS E PERFIS" },
            "4066040": { nome: "CINTA BORDE VERDE REFORZADA IC", tipo: "ACESSÓRIOS E PERFIS" },
            
            // Perfis e Outros Acessórios
            "4048659": { nome: "PER R GYP CANT 23X23 0,50 300", tipo: "ACESSÓRIOS E PERFIS" },
            "4085759": { nome: "ACESS R GYP AQ PERFIL INICIO PVC 300", tipo: "ACESSÓRIOS E PERFIS" },
            "4044121": { nome: "ACESS R GYP PLATINA 20 400MM", tipo: "ACESSÓRIOS E PERFIS" },
            "4043804": { nome: "ACESS R GYP PLATINA 25 600MM", tipo: "ACESSÓRIOS E PERFIS" },
            "4044263": { nome: "ACESS R GYP TIRANTE S/ELO 300 (100PC)", tipo: "ACESSÓRIOS E PERFIS" },
            "4043819": { nome: "ACESS R GYP UNIÃO S47 200PCS", tipo: "ACESSÓRIOS E PERFIS" },
            "4043818": { nome: "ACESS R GYP REG S47 200PCS", tipo: "ACESSÓRIOS E PERFIS" },
            "167994": { nome: "PER V GYP MONT 90X35 0,50 250(OG)", tipo: "ACESSÓRIOS E PERFIS" },
            "50093": { nome: "PSEAL-PL-SK 2,5 SK/G str.coil 25m/20mm", tipo: "ACESSÓRIOS E PERFIS" },
            "4084949": { nome: "ARAME GALV ENCAPADO 18-PVC CX 20(ES)", tipo: "ACESSÓRIOS E PERFIS" },
            
            // ===========================================
            // 4. QUÍMICOS E MASSAS
            // ===========================================
            "4577023": { nome: "GESSO RECICLADO", tipo: "QUÍMICOS E MASSAS" },
            "296922": { nome: "CP R GYP MASSA PRONTA 25KG", tipo: "QUÍMICOS E MASSAS" },
            "298833": { nome: "CP R GYP MASSA PRONTA 14 KG", tipo: "QUÍMICOS E MASSAS" },
            "4087197": { nome: "CP R GYP MASSA PO 20KG", tipo: "QUÍMICOS E MASSAS" },
            "93521": { nome: "CP V GYP MASSA PO 20Kg", tipo: "QUÍMICOS E MASSAS" },
            "104772": { nome: "CP V GYP MASSA PO 20Kg (OG)", tipo: "QUÍMICOS E MASSAS" },
            "4088092": { nome: "CP R GYP COLA 20KG", tipo: "QUÍMICOS E MASSAS" },
            "93522": { nome: "CP V GYP COLA 20Kg", tipo: "QUÍMICOS E MASSAS" },
            "164146": { nome: "CP V GYP COLA 20KG (OG)", tipo: "QUÍMICOS E MASSAS" },
            "93524": { nome: "CP V GYP FGA COLA 20Kg", tipo: "QUÍMICOS E MASSAS" },
            "93038": { nome: "CP V QUALIGESSOCOLA 20Kg", tipo: "QUÍMICOS E MASSAS" },
            "165703": { nome: "CP V QUALIGESSOCOLA 20Kg (OG)", tipo: "QUÍMICOS E MASSAS" },
            "93041": { nome: "CP V QUALIGESSOCOLA 5Kg", tipo: "QUÍMICOS E MASSAS" },
            "149280": { nome: "MASSA PROMAT P/TRATAMENTO DE JUNTAS 20KG", tipo: "QUÍMICOS E MASSAS" },
            "271453": { nome: "MASSA PROMAT P/TRAT DE JUNTAS 20KG OG", tipo: "QUÍMICOS E MASSAS" },
            "167797": { nome: "CP I SB MASSA PRONTA P/JUNTAS 22KG (OG)", tipo: "QUÍMICOS E MASSAS" },
            "295339": { nome: "MASILLA SUPERBOARD ENLUCIDO 30KG EXPO", tipo: "QUÍMICOS E MASSAS" },
            "4089902": { nome: "PROMASEAL-A white 310 ml 12pc/box Rec", tipo: "QUÍMICOS E MASSAS" },

            // ===========================================
            // 5. OUTROS REVESTIMENTOS E MATERIAIS
            // ===========================================
            "166553": { nome: "SIMPLISIMA MAD VETEADA SOFT 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "303538": { nome: "SIMPL MARM TRAVIATTA GRIS 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "304940": { nome: "SIMPL PIE CALIZA CREMA 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "304941": { nome: "SIMPL MAD RUSTICA NATURAL 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "216396": { nome: "SIMPL MAD RÚSTICA NATURAL 6MM EXP 40UN", tipo: "OUTROS REVESTIMENTOS" },
            "303533": { nome: "SIMPL CER MOSAICO AQUA 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "303537": { nome: "SIMPL MARM CALACATTA OCRE 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "303534": { nome: "SIMPL CER MOSAICO GRECCO 6MM EXP 20UN", tipo: "OUTROS REVESTIMENTOS" },
            "4084788": { nome: "LA DE PET I 12,5X1,20M 15M² P/PERFIL 70M", tipo: "OUTROS REVESTIMENTOS" }
        };
        // FIM DA BASE DE DADOS DE ITENS

        // --- Estrutura de Vagas (Vazia) ---
        let vagasEstoque = {};
        let contagensRegistradas = []; // NOVO: Armazena todas as contagens registradas
        
        // Definição das Áreas e Vagas Iniciais (Baseado no Excel)
        const AREAS = [
            "Ruas", "Superboard", "Congelados", "Segregação", "OG",
            "Quarentena", "Triagem", "Pushback", "Pezinho"
        ];
        
        // ===============================================
        // FUNÇÕES DE EXTRAÇÃO DE DADOS DO QR CODE (NOVO)
        // ===============================================
        
        // NOVO: Função para extrair o código de material do código QR bruto (ex: Q0006092983 -> 92983)
        function extrairCodigoMaterial(codigoBruto) {
            if (!codigoBruto) return '';
            
            // 1. Remove o prefixo fixo 'Q000' (case insensitive) e garante que é só dígitos
            let parteNumerica = codigoBruto.toUpperCase().replace(/^Q000/, '').trim();
            if (!parteNumerica) return '';
            
            // 2. Tenta encontrar o código de material (chave em BASE_ITENS) no final da string numérica.
            // Procura do maior comprimento (7 dígitos) para o menor (5 dígitos) para evitar truncar códigos longos.
            // Os códigos de material em BASE_ITENS têm entre 5 e 7 dígitos.
            const comprimentosPossiveis = [7, 6, 5]; 

            for (const comprimento of comprimentosPossiveis) {
                if (parteNumerica.length >= comprimento) {
                    const candidato = parteNumerica.slice(-comprimento); // Pega os últimos N dígitos
                    
                    if (BASE_ITENS[candidato]) {
                        return candidato; // Código de material válido encontrado
                    }
                }
            }
            
            // Se não encontrar match em BASE_ITENS, retorna a string numérica completa limpa
            // (Pode ser o caso do usuário digitar só o código limpo)
            return parteNumerica; 
        }
        
        // Função para atualizar o nome do material (usa a nova função de extração)
        function atualizarNomeMaterialContagem(codigoBruto) {
            const codigo = extrairCodigoMaterial(codigoBruto); // **AGORA USA O EXTRATOR**
            const nomeSpan = document.getElementById('nome-material-contagem');
            
            if (codigo && BASE_ITENS[codigo]) {
                nomeSpan.textContent = BASE_ITENS[codigo].nome;
                nomeSpan.style.color = '#28a745'; 
            } else {
                nomeSpan.textContent = 'Nome do Material (Código não encontrado na base)';
                nomeSpan.style.color = '#CC0000'; 
            }
        }
        
        // ===============================================
        // FUNÇÕES GERAIS E CÁLCULOS (Dashboard)
        // ===============================================

        // Função para calcular o % de ocupação geral e por material...
        function calcularOcupacaoGeral(vagasData = vagasEstoque) {
            // Implementação mantida
            let totalCapacidade = 0;
            let totalOcupado = 0;
            let totalItens = 0;

            for (const area in vagasData) {
                totalCapacidade += vagasData[area].capacidadeTotal || 0;
                
                for (const vagaID in vagasData[area].vagas) {
                    const vaga = vagasData[area].vagas[vagaID];
                    if (vaga.itens && vaga.itens.length > 0) {
                        totalOcupado += 1;
                        vaga.itens.forEach(item => {
                            totalItens += item.quantidade || 0;
                        });
                    }
                }
            }

            const percentual = totalCapacidade > 0 ? (totalOcupado / totalCapacidade) * 100 : 0;
            const vagasLivres = totalCapacidade - totalOcupado;
            
            return { totalCapacidade, totalOcupado, percentual, vagasLivres, totalItens };
        }

        // Função para calcular o % por tipo de material
        function calcularOcupacaoMaterial(vagasData = vagasEstoque) {
            // Implementação mantida
            const contagemMaterial = {};
            const tiposMaterial = [
                "PLACA DE GESSO (ST/RU/RF)", "PLACA CIMENTÍCIA/ESPECIAL", "ACESSÓRIOS E PERFIS", "QUÍMICOS E MASSAS", "OUTROS REVESTIMENTOS"
            ];

            tiposMaterial.forEach(tipo => contagemMaterial[tipo] = 0);
            
            let totalItens = 0;

            for (const area in vagasData) {
                for (const vagaID in vagasData[area].vagas) {
                    const vaga = vagasData[area].vagas[vagaID];
                    vaga.itens.forEach(item => {
                        const infoItem = BASE_ITENS[item.codigo];
                        if (infoItem && tiposMaterial.includes(infoItem.tipo)) {
                            contagemMaterial[infoItem.tipo] += item.quantidade || 0; 
                            totalItens += item.quantidade || 0;
                        }
                    });
                }
            }
            
            return { contagemMaterial, totalItens, tiposMaterial };
        }
        
        // Função unificada para atualizar o Dashboard (apenas para o layout manual)
        function atualizarDashboardGeral() {
             const { totalCapacidade, totalOcupado, percentual, vagasLivres } = calcularOcupacaoGeral(vagasEstoque);
             const { contagemMaterial, totalItens, tiposMaterial } = calcularOcupacaoMaterial(vagasEstoque);

            // Atualiza o Dashboard Geral
            document.getElementById('total-ocupacao').textContent = `${percentual.toFixed(1)}% (${totalOcupado} de ${totalCapacidade} Vagas)`;
            document.getElementById('progress-geral').style.width = `${percentual}%`;
            document.getElementById('vagas-livres').textContent = `${vagasLivres} Vagas Livres`;
            
            // Atualiza o Dashboard de Material
            const dashboardMaterial = document.getElementById('dashboard-material');
            dashboardMaterial.innerHTML = '<h3>% por Tipo de Material (em Qtd.) - Layout Manual</h3>';

            tiposMaterial.forEach(tipo => {
                const qtd = contagemMaterial[tipo];
                const percentualMat = totalItens > 0 ? (qtd / totalItens) * 100 : 0;
                
                const card = document.createElement('div');
                card.className = 'card-dashboard';
                card.innerHTML = `
                    <h4>${tipo.split(' (')[0].replace('/', '/<br>')}</h4>
                    <p>Qtd: ${qtd.toFixed(0)} | ${percentualMat.toFixed(1)}%</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${percentualMat.toFixed(1)}%; background-color: var(--cor-principal);"></div>
                    </div>
                `;
                dashboardMaterial.appendChild(card);
            });
        }


        // ===============================================
        // FUNÇÕES DE RENDERIZAÇÃO (Layout Manual)
        // ===============================================

        // Função para renderizar o layout das áreas e vagas (Manual - Editável)
        function renderizarLayout() {
            const container = document.getElementById('layout-areas');
            container.innerHTML = ''; 

            AREAS.forEach(areaNome => {
                const areaDiv = document.createElement('div');
                areaDiv.className = 'area';
                // Certifica-se de que a área existe, senão inicializa (útil após carregar do localStorage)
                if (!vagasEstoque[areaNome]) {
                    vagasEstoque[areaNome] = { capacidadeTotal: 0, vagas: {} };
                }
                const vagasArea = vagasEstoque[areaNome].vagas;
                const totalVagasOcupadas = Object.values(vagasArea).filter(v => v.itens && v.itens.length > 0).length;

                areaDiv.innerHTML = `<h2 onclick="toggleArea('${areaNome}', 'layout-areas')">1. Layout Manual - ${areaNome} (Capacidade: ${vagasEstoque[areaNome].capacidadeTotal} Vagas | Ocupadas: ${totalVagasOcupadas})</h2>`;

                const btnCriarVaga = document.createElement('button');
                btnCriarVaga.textContent = `+ Criar Vaga/Rua em ${areaNome}`;
                btnCriarVaga.onclick = () => abrirModalNovaVaga(areaNome);
                btnCriarVaga.style.backgroundColor = '#666';
                btnCriarVaga.style.color = 'white';
                btnCriarVaga.style.border = 'none';
                btnCriarVaga.style.padding = '8px 12px';
                btnCriarVaga.style.borderRadius = '4px';
                btnCriarVaga.style.cursor = 'pointer';
                btnCriarVaga.style.marginBottom = '10px';
                btnCriarVaga.style.marginRight = '10px';
                areaDiv.appendChild(btnCriarVaga);


                const tableContainer = document.createElement('div');
                tableContainer.id = `ruas-${areaNome.toLowerCase().replace(/\s/g, '-')}-manual`;
                tableContainer.style.display = 'block'; 
                
                const tabela = document.createElement('table');
                tabela.className = 'tabela-vagas';
                tabela.innerHTML = renderizarTabelaVagas(vagasEstoque, areaNome, true);
                tableContainer.appendChild(tabela);

                areaDiv.appendChild(tableContainer);
                container.appendChild(areaDiv);
            });
            
            atualizarDashboardGeral();
            salvarVagas();
        }
        
        // Função para gerar o HTML da Tabela (reutilizável)
        function renderizarTabelaVagas(dataStructure, areaNome, isEditable) {
             let html = `
                <thead>
                    <tr style="${isEditable ? '' : 'background-color: var(--cor-contagem);'}">
                        <th>Área/Rua</th>
                        <th>Capacidade (Vagas)</th>
                        <th>Código</th>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Lote</th>
                        <th>Validade</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const vagasArea = dataStructure[areaNome] ? dataStructure[areaNome].vagas : {};
            const vagasOrdenadas = Object.values(vagasArea).sort((a, b) => {
                // Ordenação numérica amigável por Rua 01, Rua 02, etc.
                return a.nomeRua.localeCompare(b.nomeRua, undefined, { numeric: true, sensitivity: 'base' });
            });

            vagasOrdenadas.forEach(vaga => {
                const vagaID = vaga.id;
                // Considera a vaga ocupada se tiver algum item com quantidade > 0
                const isOcupada = vaga.itens && vaga.itens.length > 0 && vaga.itens.some(i => i.quantidade > 0);
                const itemPrincipal = isOcupada ? vaga.itens[0] : {};
                const infoItem = BASE_ITENS[itemPrincipal.codigo] || { nome: 'VAGA VAZIA' };
                
                let statusClass = '';
                if (itemPrincipal.status) {
                    statusClass = 'status-' + itemPrincipal.status.toLowerCase().replace(/\s/g, '-').replace(' ', '-');
                }

                const rowClass = isEditable 
                    ? (isOcupada ? 'vaga-ocupada' : '') 
                    : (isOcupada ? 'vaga-contada' : '');

                html += `
                    <tr class="${rowClass}" onclick="${isEditable ? `abrirModalVaga('${vagaID}', '${areaNome}')` : `abrirModalVagaContada('${vagaID}', '${areaNome}')`}">
                        <td>${vaga.nomeRua}</td>
                        <td>${vaga.capacidade || 0}</td>
                        <td>${isOcupada ? itemPrincipal.codigo : ''}</td>
                        <td>${isOcupada ? infoItem.nome : 'VAGA VAZIA'}</td>
                        <td>${isOcupada ? itemPrincipal.quantidade : '0'}</td>
                        <td>${isOcupada ? itemPrincipal.lote : ''}</td>
                        <td>${isOcupada && itemPrincipal.validade ? itemPrincipal.validade : ''}</td>
                        <td class="${statusClass}">${isOcupada ? itemPrincipal.status : 'LIVRE'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            return html;
        }

        // Função para mostrar/esconder o conteúdo da área
        function toggleArea(areaNome, containerId) {
            // Implementação mantida
            const suffix = containerId.includes('contado') ? '-contado' : '-manual';
            const tableContainer = document.getElementById(`ruas-${areaNome.toLowerCase().replace(/\s/g, '-')}${suffix}`);
            if (tableContainer.style.display === 'table' || tableContainer.style.display === 'block') {
                tableContainer.style.display = 'none';
            } else {
                 tableContainer.style.display = 'block';
            }
        }
        
        // ** NOTA: As funções de modal (abrirModalNovaVaga, salvarNovaVaga, abrirModalVaga, removerVaga, salvarVagaEditada, renderizarItensModal, adicionarItem, criarFormItem, removerItem, fecharModal)
        // DEVEM ser mantidas em seu código final para que o Layout Manual funcione. Omitidas aqui por brevidade. **
        
        // Exemplo da função fecharModal para referência
        function fecharModal() {
            document.getElementById('modal-vaga').style.display = 'none';
            // Reseta para o modo edição padrão ao fechar
            document.getElementById('form-vaga').style.pointerEvents = 'auto';
            document.getElementById('form-vaga').style.opacity = '1';
            document.querySelector('#form-vaga button[type="submit"]').style.display = 'inline-block';
             
             // Habilita campos do modal
            document.querySelectorAll('#form-vaga input, #form-vaga select, #form-vaga textarea').forEach(el => el.disabled = false);
            document.getElementById('btn-adicionar-item').style.display = 'inline-block';
            document.getElementById('btn-remover-vaga').style.display = 'inline-block';

        }

        // ===============================================
        // Lógica de Contagem de Estoque
        // ===============================================

        function renderizarInterfaceContagem() {
            // Implementação mantida
            const container = document.getElementById('interface-contagem');
            container.innerHTML = `
                <h2>2. Registrar Nova Contagem de Estoque</h2>
                <p>Simule a leitura do **QR Code** (código) ou digite o código de material. Ex: Q0006092983</p>
                <form id="form-contagem">
                    <label for="campo-codigo-contagem">Código do Material (QR Code):</label>
                    <input type="text" id="campo-codigo-contagem" required onchange="atualizarNomeMaterialContagem(this.value)">
                    <span id="nome-material-contagem" class="nome-material-contagem">Nome do Material (Aguardando Código)</span>
                    
                    <label for="campo-area-contagem">Área:</label>
                    <select id="campo-area-contagem" required>
                        <option value="">Selecione a Área</option>
                        ${AREAS.map(area => `<option value="${area}">${area}</option>`).join('')}
                    </select>

                    <label for="campo-vaga-contagem">Vaga/Rua (Ex: Rua 01, Área PB 1):</label>
                    <input type="text" id="campo-vaga-contagem" placeholder="Ex: Rua 01" required>

                    <label for="campo-quantidade-contagem">Quantidade Contada (Un/Pallets/Kg):</label>
                    <input type="number" step="any" id="campo-quantidade-contagem" value="0" min="0" required>
                    
                    <label for="campo-lote-contagem">Lote:</label>
                    <input type="text" id="campo-lote-contagem" value="" placeholder="Opcional">
                    
                    <label for="campo-validade-contagem">Validade:</label>
                    <input type="date" id="campo-validade-contagem">
                    
                    <label for="campo-observacao-contagem">Observação:</label>
                    <textarea id="campo-observacao-contagem"></textarea>
                    
                    <label for="campo-data-contagem">Data da Contagem:</label>
                    <input type="date" id="campo-data-contagem" value="${new Date().toISOString().slice(0, 10)}" required>

                    <button type="submit">Registrar Contagem</button>
                    <div id="contagem-feedback"></div>
                </form>
            `;
            
            document.getElementById('form-contagem').onsubmit = adicionarContagem;
        }

        function adicionarContagem(e) {
            e.preventDefault();
            
            // 1. EXTRAI O CÓDIGO LIMPO DO MATERIAL
            const codigoBruto = document.getElementById('campo-codigo-contagem').value;
            const codigo = extrairCodigoMaterial(codigoBruto); // **USA O EXTRATOR**
            
            // 2. Coleta o restante dos dados
            const area = document.getElementById('campo-area-contagem').value;
            const vagaNome = document.getElementById('campo-vaga-contagem').value.trim();
            const quantidade = parseFloat(document.getElementById('campo-quantidade-contagem').value) || 0;
            const lote = document.getElementById('campo-lote-contagem').value.trim();
            const validade = document.getElementById('campo-validade-contagem').value;
            const observacao = document.getElementById('campo-observacao-contagem').value.trim();
            const dataContagem = document.getElementById('campo-data-contagem').value;
            
            if (!BASE_ITENS[codigo]) {
                 mostrarFeedbackContagem('O Código do Material não foi encontrado na base. Digite o QR Code ou o código limpo.', 'error');
                 return;
            }
            
            // Verifica se a Vaga/Rua existe no layout mestre 
            const areaVagas = vagasEstoque[area] ? vagasEstoque[area].vagas : {};
            const vagaExiste = Object.values(areaVagas).some(v => v.nomeRua === vagaNome);
            
            if (!vagaExiste) {
                 mostrarFeedbackContagem(`A Vaga/Rua "${vagaNome}" não existe na Área "${area}". Crie a vaga no layout manual primeiro.`, 'error');
                 return;
            }


            const novaContagem = {
                codigo, // Código Limpo
                area,
                vagaNome,
                quantidade,
                lote,
                validade,
                dataContagem,
                observacao
            };

            contagensRegistradas.push(novaContagem);
            salvarContagens();
            
            // NOVO: Atualiza a data de filtro para a data da contagem, se a tela estiver visível
            const filtroInput = document.getElementById('data-filtro-contagem');
            if(filtroInput) {
                filtroInput.value = dataContagem;
                renderizarLayoutContado(dataContagem);
            } else {
                 renderizarLayoutContado();
            }
            
            
            // Feedback e reset do formulário (mantém Area e Data)
            mostrarFeedbackContagem(`Contagem de **${BASE_ITENS[codigo].nome}** na vaga **${vagaNome}** registrada com sucesso!`, 'success');
            document.getElementById('form-contagem').reset();
            document.getElementById('campo-area-contagem').value = area; // Mantém a área selecionada
            document.getElementById('campo-data-contagem').value = dataContagem; // Mantém a data
            atualizarNomeMaterialContagem(''); // Limpa o nome do material
        }
        
        function mostrarFeedbackContagem(mensagem, tipo) {
            // Implementação mantida
            const feedback = document.getElementById('contagem-feedback');
            feedback.innerHTML = `<div class="contagem-message ${tipo}">${mensagem.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</div>`;
            setTimeout(() => feedback.innerHTML = '', 5000); // Remove a mensagem após 5s
        }
        
        // NOVO: Determina a data inicial para o filtro
        function getInitialFilterDate() {
            if (contagensRegistradas.length === 0) {
                return new Date().toISOString().slice(0, 10); // Data de hoje
            }
            
            // Encontra a data mais recente em todas as contagens
            const latestDate = contagensRegistradas.reduce((latest, current) => {
                const currentDate = new Date(current.dataContagem);
                // Retorna a data mais recente
                return currentDate > latest ? currentDate : latest; 
            }, new Date(0)); // Inicia com uma data muito antiga para a comparação
            
            return latestDate.toISOString().slice(0, 10);
        }

        // NOVO: Configura o contêiner do filtro e layout contado
        function setupContagemFilter() {
             const initialDate = getInitialFilterDate();
             
             const container = document.getElementById('layout-contado-container'); // O container pai da seção 3
             
             // Cria a interface de filtro
             const filtroDiv = document.createElement('div');
             filtroDiv.id = 'filtro-contagem-container';
             filtroDiv.innerHTML = `
                <label for="data-filtro-contagem" style="font-weight: bold; color: var(--cor-secundaria);">Filtrar Contagens por Data:</label>
                <input type="date" id="data-filtro-contagem" value="${initialDate}" onchange="renderizarLayoutContado(this.value)" style="width: 150px;">
                <p style="font-style: italic; color: var(--cor-contagem); margin-top: 10px;">Visualização **somente leitura** das contagens registradas em: <strong id="data-ultima-contagem">${initialDate}</strong>.</p>
             `;
             
             const layoutDiv = document.createElement('div');
             layoutDiv.id = 'layout-contado-areas';
             
             container.appendChild(filtroDiv);
             container.appendChild(layoutDiv);
             
             // Renderização inicial
             renderizarLayoutContado(initialDate);
        }


        function processarContagensParaLayout(dataFiltro) {
             // 1. Cria a estrutura base clonando o layout manual (preserva as ruas/capacidade)
            const layoutContado = {};
            AREAS.forEach(area => {
                layoutContado[area] = { capacidadeTotal: vagasEstoque[area].capacidadeTotal || 0, vagas: {} };
                for(const id in vagasEstoque[area].vagas) {
                     const originalVaga = vagasEstoque[area].vagas[id];
                     layoutContado[area].vagas[id] = {
                        id: originalVaga.id,
                        nomeRua: originalVaga.nomeRua,
                        capacidade: originalVaga.capacidade,
                        itens: [] // Vai ser preenchido com as contagens do dia
                    };
                }
            });

            // NOVO: Filtra as contagens pela data especificada
            const contagensDoDia = contagensRegistradas.filter(count => count.dataContagem === dataFiltro);
            
            // 2. Agrupa as contagens por Vaga ID, dando preferência à contagem mais recente (se houver repetição de item/lote no mesmo dia)
            const vagasItens = {}; // { vagaID: { 'codigo|lote': countObject } }

            contagensDoDia
                .sort((a, b) => new Date(a.dataContagem + ' ' + a.vagaNome) - new Date(b.dataContagem + ' ' + b.vagaNome)) // Ordena para garantir ordem estável
                .forEach(count => {
                    const areaNome = count.area.trim();
                    const nomeRua = count.vagaNome.trim();
                    
                    if (layoutContado[areaNome]) {
                         // Tenta encontrar a vaga pelo nome da rua no layout mestre (que foi clonado)
                         const vagaEntry = Object.values(layoutContado[areaNome].vagas).find(v => v.nomeRua === nomeRua);

                         if(vagaEntry && count.quantidade > 0) {
                            const key = `${count.codigo}|${count.lote}`;
                            
                            if (!vagasItens[vagaEntry.id]) {
                                vagasItens[vagaEntry.id] = {};
                            }
                            // O mais recente (do array filtrado e ordenado) sempre sobrescreve o anterior
                            vagasItens[vagaEntry.id][key] = count; 
                         }
                    }
                });
            
            // 3. Aplica os dados processados na estrutura do layout
            for (const areaNome in layoutContado) {
                 for (const vagaID in layoutContado[areaNome].vagas) {
                    const vaga = layoutContado[areaNome].vagas[vagaID];
                    
                    if (vagasItens[vagaID]) {
                        // Adiciona todos os itens contados (o mais recente é o único que sobrou)
                        Object.values(vagasItens[vagaID]).forEach(count => {
                            vaga.itens.push({
                                codigo: count.codigo,
                                quantidade: count.quantidade,
                                lote: count.lote,
                                validade: count.validade,
                                status: 'Contado',
                                observacao: `[Contagem ${count.dataContagem}]: ${count.observacao}`
                            });
                        });
                    }
                }
            }

            return layoutContado;
        }

        function renderizarLayoutContado(dataFiltro) {
            // Obtém a data do filtro se não for passada (para chamadas onchange)
            const filtroInput = document.getElementById('data-filtro-contagem');
            if (!dataFiltro && filtroInput) {
                dataFiltro = filtroInput.value;
            }
            
            // Se ainda não houver data ou layout, sai
            if (!dataFiltro) return; 
            
            const layoutContado = processarContagensParaLayout(dataFiltro);
            const container = document.getElementById('layout-contado-areas');
            
            // Atualiza o display de data
            document.getElementById('data-ultima-contagem').textContent = dataFiltro;
            
            // Verifica se há contagens para este dia
            const totalContagensNoDia = contagensRegistradas.filter(c => c.dataContagem === dataFiltro).length;

            if (totalContagensNoDia === 0) {
                 container.innerHTML = `<p style="color: #CC0000; font-weight: bold;">Nenhuma contagem registrada para o dia ${dataFiltro}.</p>`;
                 return;
            }
            
            container.innerHTML = '';

            AREAS.forEach(areaNome => {
                const areaDiv = document.createElement('div');
                areaDiv.className = 'area area-contada'; // Classe diferente para visual
                
                // Cálculo das vagas ocupadas neste layout (apenas contagens do dia)
                const vagasArea = layoutContado[areaNome] ? layoutContado[areaNome].vagas : {};
                const totalVagasContadas = Object.values(vagasArea).filter(v => v.itens && v.itens.length > 0 && v.itens.some(i => i.quantidade > 0)).length;

                areaDiv.innerHTML = `<h2 onclick="toggleArea('${areaNome}', 'layout-contado-areas')">3. Layout Gerado pelas Contagens - ${areaNome} (Vagas Contadas: ${totalVagasContadas})</h2>`;

                const tableContainer = document.createElement('div');
                tableContainer.id = `ruas-${areaNome.toLowerCase().replace(/\s/g, '-')}-contado`;
                tableContainer.style.display = 'block'; 
                
                const tabela = document.createElement('table');
                tabela.className = 'tabela-vagas contado';
                // Usa a função de renderização de tabela, mas com os dados de contagem e modo não editável (false)
                tabela.innerHTML = renderizarTabelaVagas(layoutContado, areaNome, false); 
                tableContainer.appendChild(tabela);

                areaDiv.appendChild(tableContainer);
                container.appendChild(areaDiv);
            });
        }
        
        // --- Persistência de Dados (Local Storage) ---
        function salvarVagas() {
            localStorage.setItem('layoutEtexSTC', JSON.stringify(vagasEstoque));
        }
        
        function salvarContagens() {
            localStorage.setItem('contagensEtexSTC', JSON.stringify(contagensRegistradas));
        }

        function carregarVagas() {
            // ... (Lógica de Carregamento e Inicialização mantida) ...
            const dadosSalvos = localStorage.getItem('layoutEtexSTC');
            if (dadosSalvos) {
                vagasEstoque = JSON.parse(dadosSalvos);
                AREAS.forEach(area => {
                    if (!vagasEstoque[area]) {
                        vagasEstoque[area] = { capacidadeTotal: 0, vagas: {} };
                    }
                });
            } else {
                // --- INICIALIZAÇÃO COM DADOS DA PLANILHA DO USUÁRIO ---
                const dadosIniciaisPlanilha = [
                    { area: "Ruas", nomeRua: "Rua 01", capacidade: 10, codigo: "92993", quantidade: 8, lote: "2024-001", status: "Liberado", validade: "2026-01-01", observacao: "" },
                    { area: "Ruas", nomeRua: "Rua 02", capacidade: 10, codigo: "92993", quantidade: 10, lote: "2024-001", status: "Liberado", validade: "2026-01-01", observacao: "" },
                    { area: "Ruas", nomeRua: "Rua 03", capacidade: 10, codigo: "140365", quantidade: 5, lote: "2024-002", status: "Na fila do FIFO", validade: "2026-01-01", observacao: "" },
                    { area: "Ruas", nomeRua: "Rua 04", capacidade: 10, codigo: "", quantidade: 0, lote: "", status: "Liberado", validade: "", observacao: "" },
                    { area: "Ruas", nomeRua: "Rua 05", capacidade: 10, codigo: "92970", quantidade: 10, lote: "2024-003", status: "Bloqueado QA", validade: "2026-01-01", observacao: "Aguardando inspeção de qualidade." },
                    { area: "Superboard", nomeRua: "Área PB 1", capacidade: 100, codigo: "142687", quantidade: 80, lote: "SB-2024-010", status: "Em cura", validade: "2026-01-01", observacao: "Em período de cura padrão" },
                    { area: "Superboard", nomeRua: "Área PB 2", capacidade: 100, codigo: "142678", quantidade: 100, lote: "SB-2024-011", status: "Bloqueado", validade: "2026-01-01", observacao: "Bloqueado por desvio de cor." },
                ];

                AREAS.forEach(area => {
                    vagasEstoque[area] = { capacidadeTotal: 0, vagas: {} };
                });
                
                // Mapeamento de dados iniciais para a estrutura
                dadosIniciaisPlanilha.forEach(dados => {
                    const areaNome = dados.area;
                    const nomeRua = dados.nomeRua;
                    
                    if (!vagasEstoque[areaNome]) {
                        vagasEstoque[areaNome] = { capacidadeTotal: 0, vagas: {} };
                    }
                    
                    const vagaID = areaNome.toLowerCase().replace(/\s/g, '-') + '-' + nomeRua.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, '');

                    if (!vagasEstoque[areaNome].vagas[vagaID]) {
                         vagasEstoque[areaNome].vagas[vagaID] = {
                            id: vagaID,
                            nomeRua: nomeRua,
                            capacidade: dados.capacidade,
                            itens: []
                        };
                         vagasEstoque[areaNome].capacidadeTotal += dados.capacidade;
                    }
                    
                    if (dados.codigo && dados.quantidade > 0) {
                         vagasEstoque[areaNome].vagas[vagaID].itens.push({
                            codigo: dados.codigo,
                            quantidade: dados.quantidade,
                            lote: dados.lote,
                            validade: dados.validade,
                            status: dados.status,
                            observacao: dados.observacao
                        });
                    }
                });
            }
            
            // Carrega as contagens registradas
            const dadosContagem = localStorage.getItem('contagensEtexSTC');
            if (dadosContagem) {
                contagensRegistradas = JSON.parse(dadosContagem);
            }
        }
        
        // --- Inicialização ---
        window.onload = () => {
            carregarVagas();
            renderizarInterfaceContagem(); // 2. Renderiza o formulário de contagem
            renderizarLayout(); // 1. Renderiza o layout manual (Editável)
            setupContagemFilter(); // 3. Configura o filtro e renderiza o layout contado
            
            // Configurações do Modal (fechar)
            document.querySelector('.close-button').onclick = fecharModal;
            window.onclick = (event) => {
                const modal = document.getElementById('modal-vaga');
                if (event.target === modal) {
                    fecharModal();
                }
            };
        };
        
        // ** NOTA: Para um código funcional completo, todas as funções do Modal (abrirModalVaga, salvarVagaEditada, etc.) DEVEM ser incluídas. **
    </script>
</head>
<body>

    <header>
        <h1>Layout Etex STC</h1>
        <p>Sistema de Vagas e Ocupação de Estoque</p>
    </header>

    <main>
        
        <section id="dashboard">
            <div class="card-dashboard">
                <h3>Ocupação Geral do Estoque (Manual)</h3>
                <p id="total-ocupacao">0% (0 de 0 Vagas)</p>
                <div class="progress-bar-container">
                    <div id="progress-geral" class="progress-bar" style="width: 0%;"></div>
                </div>
                <p id="vagas-livres" style="font-size: 0.9em; margin-top: 10px;">0 Vagas Livres</p>
            </div>
            
            <div id="dashboard-material" style="display: flex; flex-wrap: wrap; gap: 20px; flex-grow: 3;">
                </div>
        </section>

        <hr>

        <section id="interface-contagem">
            </section>
        
        <hr>

        <section>
            <h1>1. Layout de Estoque Atual (Manual)</h1>
            <p style="font-style: italic; color: var(--cor-principal);">Clique em uma vaga para editar ou adicionar itens. Use este layout para gerenciar o estoque mestre.</p>
            <div id="layout-areas">
                </div>
        </section>
        
        <hr>

        <section>
             <h1>3. Layout Gerado pelas Contagens Registradas (Instantâneo Diário)</h1>
             <div id="layout-contado-container">
                 </div>
        </section>


    </main>
    
    <div id="modal-vaga" class="modal" style="display:none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; border-radius: 8px;">
            <span class="close-button" style="color: #aaa; float: right; font-size: 28px; font-weight: bold;">&times;</span>
            <h2 id="modal-titulo">Editar Vaga</h2>
            <form id="form-vaga">
                <input type="hidden" id="vaga-id">
                <input type="hidden" id="vaga-area">

                <label for="nome-vaga">Nome da Vaga/Rua:</label>
                <input type="text" id="nome-vaga" required>

                <label for="capacidade-vaga">Capacidade (Vagas):</label>
                <input type="number" id="capacidade-vaga" min="1" required>

                <h3>Itens Atuais na Vaga:</h3>
                <div id="container-itens">
                    </div>

                <button type="button" id="btn-adicionar-item" onclick="adicionarItem()">+ Adicionar Item</button>

                <button type="submit" style="background-color: var(--cor-principal); color: white;">Salvar Alterações</button>
                <button type="button" id="btn-remover-vaga" onclick="removerVaga()" style="background-color: #dc3545; color: white;">Remover Vaga</button>
            </form>
        </div>
    </div>


</body>
</html>
