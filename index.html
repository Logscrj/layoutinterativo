<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contagem de Estoque</title>
    
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            margin-top: 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-registrar {
            background-color: #4CAF50;
            color: white;
            width: 100%;
        }
        #btn-registrar:hover {
            background-color: #45a049;
        }
        #btn-scanner {
            background-color: #2196F3;
            color: white;
            width: 100%;
            margin-bottom: 10px;
        }
        #btn-scanner:hover {
            background-color: #1e87db;
        }
        .alerta {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        #leitor-qr-code {
            width: 100%;
            margin-top: 10px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            display: none; /* Inicia oculto */
        }
        #tabela-contagens {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #tabela-contagens th, #tabela-contagens td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #tabela-contagens th {
            background-color: #f2f2f2;
        }
        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>InventÃ¡rio e Contagem de Estoque</h1>

        <section id="visualizacao-contagens">
            <h2>1. Contagens Registradas</h2>
            <p>Total de Contagens: <span id="total-contagens">0</span></p>
            <table id="tabela-contagens">
                <thead>
                    <tr>
                        <th>CÃ³d. Material</th>
                        <th>Nome Material</th>
                        <th>Data</th>
                        <th>Quantidade</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button onclick="limparContagens()" style="background-color: #f44336; color: white;">Limpar Contagens Salvas</button>
        </section>

        <hr>

        <section id="registro-contagem">
            <h2>2. Registrar Nova Contagem de Estoque</h2>
            <form id="form-contagem" onsubmit="adicionarContagem(event)">

                <label for="campo-codigo-contagem">CÃ³digo do Material (QR Code ou Digitar):</label>
                <input type="text" id="campo-codigo-contagem" oninput="atualizarNomeMaterialContagem(this.value)" required>
                
                <button type="button" id="btn-scanner" onclick="iniciarScanner()">
                    Abrir CÃ¢mera (QR Code) ðŸ“·
                </button>
                <div id="leitor-qr-code"></div>
                
                <p id="nome-material-contagem" style="margin-top: 5px; font-style: italic; color: #555;">Nome do Material: N/A</p>
                <input type="hidden" id="campo-nome-contagem" value="">
                
                <label for="campo-data-contagem">Data da Contagem:</label>
                <input type="date" id="campo-data-contagem" value="" required>

                <label for="campo-quantidade-contagem">Quantidade Contada:</label>
                <input type="number" step="any" id="campo-quantidade-contagem" value="0" min="0" required>
                
                <button type="submit" id="btn-registrar">Registrar Contagem</button>
                <p id="mensagem-alerta" class="alerta"></p>
            </form>
        </section>

    </div>

    <script>
        // --- BASE DE DADOS E LÃ“GICA DO INVENTÃRIO ---
        
        const BASE_ITENS = {
            // CÃ³digo Limpo (sem prefixo Q000) : Nome do Material
            "92983": "CH V GYP ST BR12,5-120X180",
            "92939": "CH V GYP ST BR12.5-120X240",
            "4577023": "GESSO RECICLADO",
            "313665": "CH GYP GWD BR12,5-120X240",
            "142685": "SUPERBOARD ST BQ 6MM 1200X2400",
            "4066969": "FIX IB GYP TB 3,5X25 CX 1.000",
            "4094219": "ACAB R GYP GWD TELA P/JUNTAS 20CMX50M RL",
            "140358": "CH V GYP ST BR6,4-120X240",
            "142687": "SUPERBOARD ST BQ 10MM 1200X2400",
            "93018": "CH V GYP ST BR12,5-120X270",
            "304393": "CH V PROMAPRO+ RF BR15,0-120X240",
            "4066968": "FIX IB GYP TA 3,5X45 CX 500",
            "93022": "CH V GYP ST BR12,5-120X240",
            // Adicione mais itens conforme seu arquivo estoque completo.pdf
        };

        function extrairCodigoMaterial(codigoBruto) {
            // Regex para extrair a parte numÃ©rica apÃ³s 'Q00060'
            const match = codigoBruto.match(/Q00060(\d+)/);
            if (match && match[1]) {
                return match[1]; // Retorna apenas 92983, 92939, etc.
            }
            // Caso seja digitado o cÃ³digo limpo, retorna ele mesmo
            return codigoBruto; 
        }

        function atualizarNomeMaterialContagem(codigoBruto) {
            const codigo = extrairCodigoMaterial(codigoBruto);
            const nome = BASE_ITENS[codigo] || "NÃƒO ENCONTRADO na base de itens.";
            
            document.getElementById('nome-material-contagem').textContent = `Nome do Material: ${nome}`;
            document.getElementById('campo-nome-contagem').value = nome;
            
            // Alerta se o material nÃ£o for encontrado
            const alerta = document.getElementById('mensagem-alerta');
            if (!BASE_ITENS[codigo] && codigoBruto.length > 0) {
                alerta.textContent = "âš ï¸ CÃ³digo nÃ£o encontrado. Verifique a base de dados.";
            } else {
                alerta.textContent = "";
            }
        }
        
        function carregarContagens() {
            const contagens = JSON.parse(localStorage.getItem('contagensEstoque')) || [];
            return contagens;
        }

        function salvarContagens(contagens) {
            localStorage.setItem('contagensEstoque', JSON.stringify(contagens));
            renderizarContagens();
        }

        function adicionarContagem(event) {
            event.preventDefault();
            
            // Verifica se o scanner estÃ¡ rodando e o interrompe
            if (isScanning) pararScanner();

            const codigoBruto = document.getElementById('campo-codigo-contagem').value;
            const codigoMaterial = extrairCodigoMaterial(codigoBruto);
            const nomeMaterial = document.getElementById('campo-nome-contagem').value;
            const dataContagem = document.getElementById('campo-data-contagem').value;
            const quantidade = parseFloat(document.getElementById('campo-quantidade-contagem').value);

            if (nomeMaterial.includes("NÃƒO ENCONTRADO") || codigoBruto.length === 0) {
                alert("Erro: O material nÃ£o foi encontrado ou o campo CÃ³digo do Material estÃ¡ vazio. Registre apenas materiais vÃ¡lidos.");
                return;
            }

            const novaContagem = {
                id: Date.now(),
                codigo: codigoMaterial,
                nome: nomeMaterial,
                data: dataContagem,
                quantidade: quantidade
            };

            const contagens = carregarContagens();
            contagens.push(novaContagem);
            salvarContagens(contagens);

            // Limpar o formulÃ¡rio apÃ³s salvar
            document.getElementById('form-contagem').reset();
            document.getElementById('campo-data-contagem').value = new Date().toISOString().slice(0, 10);
            atualizarNomeMaterialContagem('');
            document.getElementById('mensagem-alerta').textContent = '';
        }

        function renderizarContagens() {
            const contagens = carregarContagens();
            const tabelaBody = document.querySelector('#tabela-contagens tbody');
            tabelaBody.innerHTML = '';
            
            document.getElementById('total-contagens').textContent = contagens.length;

            contagens.forEach(c => {
                const row = tabelaBody.insertRow();
                row.insertCell().textContent = c.codigo;
                row.insertCell().textContent = c.nome;
                row.insertCell().textContent = c.data;
                row.insertCell().textContent = c.quantidade;
            });
        }

        function limparContagens() {
            if (confirm("Tem certeza que deseja limpar todas as contagens salvas? Esta aÃ§Ã£o Ã© irreversÃ­vel.")) {
                localStorage.removeItem('contagensEstoque');
                renderizarContagens();
            }
        }
        
        // --- LÃ“GICA DO SCANNER QR CODE ---
        
        const html5QrCode = new Html5Qrcode("leitor-qr-code");
        let isScanning = false;
        const btnScanner = document.getElementById('btn-scanner');

        function iniciarScanner() {
            const scannerDiv = document.getElementById('leitor-qr-code');
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            if (!isScanning) {
                // Inicia o scanner
                html5QrCode.start(
                    { facingMode: "environment" }, // Usa a cÃ¢mera traseira (melhor para QR Codes)
                    config,
                    (decodedText, decodedResult) => {
                        // Sucesso na leitura do QR Code
                        
                        // 1. Preenche o campo de input
                        const inputCampo = document.getElementById('campo-codigo-contagem');
                        inputCampo.value = decodedText;
                        
                        // 2. Aciona a funÃ§Ã£o de lookup do nome do material
                        atualizarNomeMaterialContagem(decodedText); 
                        
                        // 3. Para o scanner
                        pararScanner();

                        alert(`QR Code lido: ${decodedText}`); // Feedback visual
                        
                        // Opcional: Focar no campo de quantidade para agilizar o fluxo
                        document.getElementById('campo-quantidade-contagem').focus();
                    },
                    (errorMessage) => {
                        // Erro de decodificaÃ§Ã£o (normal enquanto escaneia)
                        // console.log(`Erro: ${errorMessage}`);
                    }
                ).catch((err) => {
                    alert("Erro ao iniciar a cÃ¢mera. Certifique-se de que a permissÃ£o foi concedida. " + err);
                    isScanning = false;
                    btnScanner.textContent = "Abrir CÃ¢mera (QR Code) ðŸ“·";
                });
                
                isScanning = true;
                scannerDiv.style.display = 'block';
                btnScanner.textContent = "Fechar CÃ¢mera";

            } else {
                // Para o scanner se jÃ¡ estiver rodando
                pararScanner();
            }
        }

        function pararScanner() {
            if (isScanning) {
                html5QrCode.stop().then((ignore) => {
                    document.getElementById('leitor-qr-code').style.display = 'none';
                    isScanning = false;
                    btnScanner.textContent = "Abrir CÃ¢mera (QR Code) ðŸ“·";
                }).catch((err) => {
                    console.error("Erro ao parar o scanner.", err);
                    isScanning = false;
                    btnScanner.textContent = "Abrir CÃ¢mera (QR Code) ðŸ“·";
                });
            }
        }
        
        // --- INICIALIZAÃ‡ÃƒO DA PÃGINA ---

        document.addEventListener('DOMContentLoaded', () => {
            // Define a data atual no campo
            document.getElementById('campo-data-contagem').value = new Date().toISOString().slice(0, 10);
            // Carrega as contagens salvas
            renderizarContagens();
        });
    </script>
</body>
</html>
